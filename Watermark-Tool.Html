<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watermark Tool - Precise Placement</title>
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4cc9f0;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --border-radius: 10px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fb;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .app-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .upload-section {
            flex: 1;
            min-width: 300px;
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .preview-section {
            flex: 2;
            min-width: 300px;
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }
        
        .controls-section {
            flex: 1;
            min-width: 300px;
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .section-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray-light);
            color: var(--primary);
        }
        
        .upload-area {
            border: 2px dashed var(--gray);
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        
        .upload-area:hover {
            border-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.05);
        }
        
        .upload-area i {
            font-size: 48px;
            color: var(--gray);
            margin-bottom: 10px;
        }
        
        .upload-area p {
            margin-bottom: 15px;
            color: var(--gray);
        }
        
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-secondary {
            background-color: var(--gray);
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .btn-success {
            background-color: var(--success);
        }
        
        .btn-success:hover {
            background-color: #3aa8d0;
        }
        
        .preview-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--gray-light);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            min-height: 400px;
            position: relative;
        }
        
        #imagePreview {
            max-width: 100%;
            max-height: 100%;
            display: none;
        }
        
        .placeholder-text {
            color: var(--gray);
            text-align: center;
            padding: 20px;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--gray-light);
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .range-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .range-control input {
            flex: 1;
        }
        
        .range-value {
            min-width: 40px;
            text-align: center;
        }
        
        .color-picker {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .color-picker input {
            width: 50px;
            height: 40px;
            border: none;
            padding: 0;
            cursor: pointer;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-group input {
            width: 18px;
            height: 18px;
        }
        
        .position-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-top: 10px;
        }
        
        .position-btn {
            padding: 10px;
            background-color: var(--gray-light);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        
        .position-btn.active {
            background-color: var(--primary);
            color: white;
        }
        
        .position-btn:hover:not(.active) {
            background-color: #dae0e5;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-buttons .btn {
            flex: 1;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            color: var(--gray);
            font-size: 0.9rem;
            border-top: 1px solid var(--gray-light);
        }
        
        /* Watermark positioning styles */
        .watermark-overlay {
            position: absolute;
            cursor: move;
            user-select: none;
            transition: transform 0.1s;
        }
        
        .watermark-overlay.text {
            padding: 5px;
            white-space: nowrap;
        }
        
        .watermark-overlay.image {
            pointer-events: none;
        }
        
        .watermark-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--primary);
            border: 2px solid white;
            border-radius: 50%;
            bottom: -6px;
            right: -6px;
            cursor: nwse-resize;
            display: none;
        }
        
        .watermark-overlay.active .watermark-handle {
            display: block;
        }
        
        .positioning-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .positioning-options .btn {
            flex: 1;
            padding: 8px;
            font-size: 0.9rem;
        }
        
        .coordinates-display {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .preview-section, .upload-section, .controls-section {
                width: 100%;
            }
            
            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Watermark Tool</h1>
            <p class="subtitle">Add text or image watermarks with precise placement ‚Ä¢ Improve quality ‚Ä¢ Convert to HD</p>
        </header>
        
        <div class="app-container">
            <div class="upload-section">
                <h2 class="section-title">Upload Image</h2>
                <div class="upload-area" id="uploadArea">
                    <i>üìÅ</i>
                    <p>Drag & drop your image here or click to browse</p>
                    <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                    <button class="btn" id="browseBtn">Browse Files</button>
                </div>
                <div class="control-group">
                    <label class="control-label">Quality Enhancement</label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="enhanceQuality" checked>
                        <label for="enhanceQuality">Enhance image quality</label>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label">Output Quality</label>
                    <div class="range-control">
                        <input type="range" id="qualitySlider" min="1" max="100" value="90">
                        <span class="range-value" id="qualityValue">90%</span>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label">HD Conversion</label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="hdConversion" checked>
                        <label for="hdConversion">Convert to HD (if needed)</label>
                    </div>
                </div>
            </div>
            
            <div class="preview-section">
                <h2 class="section-title">Preview & Positioning</h2>
                <div class="preview-container" id="previewContainer">
                    <img id="imagePreview" alt="Preview">
                    <div class="placeholder-text" id="previewPlaceholder">
                        Your image will appear here after upload
                    </div>
                    <!-- Watermark overlay will be added here dynamically -->
                </div>
                <div class="positioning-options">
                    <button class="btn btn-secondary" id="precisePositionBtn">Precise Placement Mode</button>
                    <button class="btn" id="gridPositionBtn">Grid Placement</button>
                </div>
                <div class="coordinates-display">
                    <span>X: <span id="positionX">0</span>px</span>
                    <span>Y: <span id="positionY">0</span>px</span>
                    <span>Drag to position</span>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" id="resetBtn">Reset</button>
                    <button class="btn btn-success" id="downloadBtn">Download Image</button>
                </div>
            </div>
            
            <div class="controls-section">
                <div class="tabs">
                    <div class="tab active" data-tab="text">Text Watermark</div>
                    <div class="tab" data-tab="image">Image Watermark</div>
                </div>
                
                <div class="tab-content active" id="textTab">
                    <div class="control-group">
                        <label class="control-label" for="watermarkText">Watermark Text</label>
                        <input type="text" id="watermarkText" class="form-control" placeholder="Enter your watermark text" value="Your Watermark">
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="textFont">Font Family</label>
                        <select id="textFont" class="form-control">
                            <option value="Arial, sans-serif">Arial</option>
                            <option value="'Times New Roman', serif">Times New Roman</option>
                            <option value="'Courier New', monospace">Courier New</option>
                            <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
                            <option value="Impact, sans-serif">Impact</option>
                            <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Segoe UI</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="textSize">Font Size</label>
                        <div class="range-control">
                            <input type="range" id="textSize" min="10" max="100" value="30">
                            <span class="range-value" id="textSizeValue">30px</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">Text Color</label>
                        <div class="color-picker">
                            <input type="color" id="textColor" value="#ffffff">
                            <span id="textColorValue">#FFFFFF</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">Background Color</label>
                        <div class="color-picker">
                            <input type="color" id="textBgColor" value="#000000">
                            <span id="textBgColorValue">#000000</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">Opacity</label>
                        <div class="range-control">
                            <input type="range" id="textOpacity" min="0" max="100" value="70">
                            <span class="range-value" id="textOpacityValue">70%</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">Quick Position</label>
                        <div class="position-controls">
                            <button class="position-btn" data-position="top-left">Top Left</button>
                            <button class="position-btn" data-position="top-center">Top Center</button>
                            <button class="position-btn" data-position="top-right">Top Right</button>
                            <button class="position-btn" data-position="center-left">Center Left</button>
                            <button class="position-btn" data-position="center">Center</button>
                            <button class="position-btn" data-position="center-right">Center Right</button>
                            <button class="position-btn" data-position="bottom-left">Bottom Left</button>
                            <button class="position-btn active" data-position="bottom-center">Bottom Center</button>
                            <button class="position-btn" data-position="bottom-right">Bottom Right</button>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="imageTab">
                    <div class="control-group">
                        <label class="control-label">Upload Watermark Image</label>
                        <div class="upload-area small" id="watermarkUploadArea">
                            <i>üñºÔ∏è</i>
                            <p>Click to upload watermark image</p>
                            <input type="file" id="watermarkImageUpload" accept="image/*" style="display: none;">
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">Size</label>
                        <div class="range-control">
                            <input type="range" id="watermarkSize" min="5" max="50" value="20">
                            <span class="range-value" id="watermarkSizeValue">20%</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">Opacity</label>
                        <div class="range-control">
                            <input type="range" id="watermarkOpacity" min="0" max="100" value="50">
                            <span class="range-value" id="watermarkOpacityValue">50%</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">Quick Position</label>
                        <div class="position-controls">
                            <button class="position-btn" data-position="top-left">Top Left</button>
                            <button class="position-btn" data-position="top-center">Top Center</button>
                            <button class="position-btn" data-position="top-right">Top Right</button>
                            <button class="position-btn" data-position="center-left">Center Left</button>
                            <button class="position-btn" data-position="center">Center</button>
                            <button class="position-btn" data-position="center-right">Center Right</button>
                            <button class="position-btn" data-position="bottom-left">Bottom Left</button>
                            <button class="position-btn active" data-position="bottom-center">Bottom Center</button>
                            <button class="position-btn" data-position="bottom-right">Bottom Right</button>
                        </div>
                    </div>
                </div>
                
                <div class="control-group">
                    <button class="btn" id="applyWatermarkBtn">Apply Watermark</button>
                    <button class="btn btn-secondary" id="updatePreviewBtn" style="margin-top: 10px; width: 100%;">Update Preview</button>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Watermark Tool &copy; 2023 | Protect your creative work with professional watermarks</p>
        </footer>
    </div>

    <script>
        // DOM Elements
        const uploadArea = document.getElementById('uploadArea');
        const imageUpload = document.getElementById('imageUpload');
        const browseBtn = document.getElementById('browseBtn');
        const imagePreview = document.getElementById('imagePreview');
        const previewContainer = document.getElementById('previewContainer');
        const previewPlaceholder = document.getElementById('previewPlaceholder');
        const resetBtn = document.getElementById('resetBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const positionBtns = document.querySelectorAll('.position-btn');
        const applyWatermarkBtn = document.getElementById('applyWatermarkBtn');
        const updatePreviewBtn = document.getElementById('updatePreviewBtn');
        const precisePositionBtn = document.getElementById('precisePositionBtn');
        const gridPositionBtn = document.getElementById('gridPositionBtn');
        const positionX = document.getElementById('positionX');
        const positionY = document.getElementById('positionY');
        
        // Text watermark controls
        const watermarkText = document.getElementById('watermarkText');
        const textFont = document.getElementById('textFont');
        const textSize = document.getElementById('textSize');
        const textSizeValue = document.getElementById('textSizeValue');
        const textColor = document.getElementById('textColor');
        const textColorValue = document.getElementById('textColorValue');
        const textBgColor = document.getElementById('textBgColor');
        const textBgColorValue = document.getElementById('textBgColorValue');
        const textOpacity = document.getElementById('textOpacity');
        const textOpacityValue = document.getElementById('textOpacityValue');
        
        // Image watermark controls
        const watermarkUploadArea = document.getElementById('watermarkUploadArea');
        const watermarkImageUpload = document.getElementById('watermarkImageUpload');
        const watermarkSize = document.getElementById('watermarkSize');
        const watermarkSizeValue = document.getElementById('watermarkSizeValue');
        const watermarkOpacity = document.getElementById('watermarkOpacity');
        const watermarkOpacityValue = document.getElementById('watermarkOpacityValue');
        
        // Quality controls
        const enhanceQuality = document.getElementById('enhanceQuality');
        const qualitySlider = document.getElementById('qualitySlider');
        const qualityValue = document.getElementById('qualityValue');
        const hdConversion = document.getElementById('hdConversion');
        
        // State variables
        let originalImage = null;
        let currentImage = null;
        let watermarkImage = null;
        let activeTab = 'text';
        let textPosition = 'bottom-center';
        let imagePosition = 'bottom-center';
        let watermarkOverlay = null;
        let isDragging = false;
        let isResizing = false;
        let dragStartX, dragStartY;
        let overlayStartX, overlayStartY;
        let preciseMode = false;
        
        // Event Listeners
        browseBtn.addEventListener('click', () => imageUpload.click());
        uploadArea.addEventListener('click', () => imageUpload.click());
        imageUpload.addEventListener('change', handleImageUpload);
        resetBtn.addEventListener('click', resetImage);
        downloadBtn.addEventListener('click', downloadImage);
        
        // Tab switching
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}Tab`).classList.add('active');
                activeTab = tab.dataset.tab;
                
                // Update preview if watermark exists
                if (watermarkOverlay) {
                    updateWatermarkPreview();
                }
            });
        });
        
        // Position buttons
        positionBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const parent = btn.closest('.position-controls');
                parent.querySelectorAll('.position-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                if (parent.closest('#textTab')) {
                    textPosition = btn.dataset.position;
                } else {
                    imagePosition = btn.dataset.position;
                }
                
                // If not in precise mode, apply the grid position
                if (!preciseMode) {
                    applyGridPosition();
                }
            });
        });
        
        // Text controls
        textSize.addEventListener('input', () => {
            textSizeValue.textContent = `${textSize.value}px`;
            if (watermarkOverlay && activeTab === 'text') {
                updateWatermarkPreview();
            }
        });
        
        textColor.addEventListener('input', () => {
            textColorValue.textContent = textColor.value.toUpperCase();
            if (watermarkOverlay && activeTab === 'text') {
                updateWatermarkPreview();
            }
        });
        
        textBgColor.addEventListener('input', () => {
            textBgColorValue.textContent = textBgColor.value.toUpperCase();
            if (watermarkOverlay && activeTab === 'text') {
                updateWatermarkPreview();
            }
        });
        
        textOpacity.addEventListener('input', () => {
            textOpacityValue.textContent = `${textOpacity.value}%`;
            if (watermarkOverlay && activeTab === 'text') {
                updateWatermarkStyle();
            }
        });
        
        // Image watermark controls
        watermarkUploadArea.addEventListener('click', () => watermarkImageUpload.click());
        watermarkImageUpload.addEventListener('change', handleWatermarkUpload);
        
        watermarkSize.addEventListener('input', () => {
            watermarkSizeValue.textContent = `${watermarkSize.value}%`;
            if (watermarkOverlay && activeTab === 'image') {
                updateWatermarkPreview();
            }
        });
        
        watermarkOpacity.addEventListener('input', () => {
            watermarkOpacityValue.textContent = `${watermarkOpacity.value}%`;
            if (watermarkOverlay && activeTab === 'image') {
                updateWatermarkStyle();
            }
        });
        
        // Quality controls
        qualitySlider.addEventListener('input', () => {
            qualityValue.textContent = `${qualitySlider.value}%`;
        });
        
        // Positioning mode buttons
        precisePositionBtn.addEventListener('click', () => {
            preciseMode = true;
            precisePositionBtn.classList.add('active');
            gridPositionBtn.classList.remove('active');
            if (watermarkOverlay) {
                enablePrecisePositioning();
            }
        });
        
        gridPositionBtn.addEventListener('click', () => {
            preciseMode = false;
            gridPositionBtn.classList.add('active');
            precisePositionBtn.classList.remove('active');
            applyGridPosition();
        });
        
        // Apply watermark
        applyWatermarkBtn.addEventListener('click', applyWatermark);
        updatePreviewBtn.addEventListener('click', updateWatermarkPreview);
        
        // Functions
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                alert('Please select an image file.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                originalImage = new Image();
                originalImage.onload = function() {
                    currentImage = originalImage;
                    displayImage(currentImage);
                    previewPlaceholder.style.display = 'none';
                    imagePreview.style.display = 'block';
                    
                    // Initialize watermark overlay
                    initWatermarkOverlay();
                };
                originalImage.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function handleWatermarkUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                alert('Please select an image file.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                watermarkImage = new Image();
                watermarkImage.onload = function() {
                    if (activeTab === 'image') {
                        updateWatermarkPreview();
                    }
                };
                watermarkImage.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function displayImage(img) {
            imagePreview.src = img.src;
        }
        
        function resetImage() {
            if (originalImage) {
                currentImage = originalImage;
                displayImage(currentImage);
                if (watermarkOverlay) {
                    watermarkOverlay.remove();
                    watermarkOverlay = null;
                }
                initWatermarkOverlay();
            }
        }
        
        function initWatermarkOverlay() {
            if (watermarkOverlay) {
                watermarkOverlay.remove();
            }
            
            watermarkOverlay = document.createElement('div');
            watermarkOverlay.className = `watermark-overlay ${activeTab}`;
            previewContainer.appendChild(watermarkOverlay);
            
            if (activeTab === 'text') {
                watermarkOverlay.textContent = watermarkText.value || 'Your Watermark';
                watermarkOverlay.style.color = textColor.value;
                watermarkOverlay.style.fontFamily = textFont.value;
                watermarkOverlay.style.fontSize = `${textSize.value}px`;
                watermarkOverlay.style.backgroundColor = textBgColor.value;
                watermarkOverlay.style.opacity = textOpacity.value / 100;
                watermarkOverlay.style.padding = '5px 10px';
                watermarkOverlay.style.borderRadius = '3px';
            } else if (activeTab === 'image' && watermarkImage) {
                const sizePercent = parseInt(watermarkSize.value) / 100;
                const imgElem = document.createElement('img');
                imgElem.src = watermarkImage.src;
                imgElem.style.width = '100%';
                imgElem.style.height = '100%';
                imgElem.style.opacity = watermarkOpacity.value / 100;
                watermarkOverlay.appendChild(imgElem);
                
                // Set initial size based on percentage of preview container
                const containerWidth = previewContainer.clientWidth;
                const watermarkWidth = containerWidth * sizePercent;
                watermarkOverlay.style.width = `${watermarkWidth}px`;
                
                // Maintain aspect ratio
                const aspectRatio = watermarkImage.height / watermarkImage.width;
                watermarkOverlay.style.height = `${watermarkWidth * aspectRatio}px`;
            }
            
            // Add resize handle
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'watermark-handle';
            watermarkOverlay.appendChild(resizeHandle);
            
            // Set initial position
            applyGridPosition();
            
            // Enable dragging if in precise mode
            if (preciseMode) {
                enablePrecisePositioning();
            }
            
            // Add event listeners for resize handle
            resizeHandle.addEventListener('mousedown', startResize);
        }
        
        function enablePrecisePositioning() {
            if (!watermarkOverlay) return;
            
            watermarkOverlay.classList.add('active');
            watermarkOverlay.style.cursor = 'move';
            
            // Remove any existing event listeners first
            watermarkOverlay.removeEventListener('mousedown', startDrag);
            document.removeEventListener('mousemove', duringDrag);
            document.removeEventListener('mouseup', endDrag);
            
            // Add new event listeners
            watermarkOverlay.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', duringDrag);
            document.addEventListener('mouseup', endDrag);
        }
        
        function startDrag(e) {
            if (e.target.classList.contains('watermark-handle')) return;
            
            isDragging = true;
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            
            const rect = watermarkOverlay.getBoundingClientRect();
            overlayStartX = rect.left;
            overlayStartY = rect.top;
            
            watermarkOverlay.style.zIndex = '10';
            e.preventDefault();
        }
        
        function duringDrag(e) {
            if (!isDragging) return;
            
            const deltaX = e.clientX - dragStartX;
            const deltaY = e.clientY - dragStartY;
            
            const newX = overlayStartX + deltaX;
            const newY = overlayStartY + deltaY;
            
            // Constrain to preview container
            const containerRect = previewContainer.getBoundingClientRect();
            const overlayRect = watermarkOverlay.getBoundingClientRect();
            
            const maxX = containerRect.right - overlayRect.width;
            const maxY = containerRect.bottom - overlayRect.height;
            
            const constrainedX = Math.max(containerRect.left, Math.min(newX, maxX));
            const constrainedY = Math.max(containerRect.top, Math.min(newY, maxY));
            
            watermarkOverlay.style.left = `${constrainedX - containerRect.left}px`;
            watermarkOverlay.style.top = `${constrainedY - containerRect.top}px`;
            
            // Update coordinates display
            updateCoordinatesDisplay();
        }
        
        function endDrag() {
            isDragging = false;
            watermarkOverlay.style.zIndex = '5';
        }
        
        function startResize(e) {
            isResizing = true;
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            
            const rect = watermarkOverlay.getBoundingClientRect();
            overlayStartX = rect.width;
            overlayStartY = rect.height;
            
            e.stopPropagation();
            e.preventDefault();
        }
        
        function applyGridPosition() {
            if (!watermarkOverlay || !previewContainer) return;
            
            const containerRect = previewContainer.getBoundingClientRect();
            const overlayRect = watermarkOverlay.getBoundingClientRect();
            const padding = 20;
            
            let left, top;
            const position = activeTab === 'text' ? textPosition : imagePosition;
            
            switch (position) {
                case 'top-left':
                    left = padding;
                    top = padding;
                    break;
                case 'top-center':
                    left = (containerRect.width - overlayRect.width) / 2;
                    top = padding;
                    break;
                case 'top-right':
                    left = containerRect.width - overlayRect.width - padding;
                    top = padding;
                    break;
                case 'center-left':
                    left = padding;
                    top = (containerRect.height - overlayRect.height) / 2;
                    break;
                case 'center':
                    left = (containerRect.width - overlayRect.width) / 2;
                    top = (containerRect.height - overlayRect.height) / 2;
                    break;
                case 'center-right':
                    left = containerRect.width - overlayRect.width - padding;
                    top = (containerRect.height - overlayRect.height) / 2;
                    break;
                case 'bottom-left':
                    left = padding;
                    top = containerRect.height - overlayRect.height - padding;
                    break;
                case 'bottom-center':
                    left = (containerRect.width - overlayRect.width) / 2;
                    top = containerRect.height - overlayRect.height - padding;
                    break;
                case 'bottom-right':
                    left = containerRect.width - overlayRect.width - padding;
                    top = containerRect.height - overlayRect.height - padding;
                    break;
            }
            
            watermarkOverlay.style.left = `${left}px`;
            watermarkOverlay.style.top = `${top}px`;
            
            updateCoordinatesDisplay();
        }
        
        function updateCoordinatesDisplay() {
            if (!watermarkOverlay) return;
            
            const rect = watermarkOverlay.getBoundingClientRect();
            const containerRect = previewContainer.getBoundingClientRect();
            
            const x = Math.round(rect.left - containerRect.left);
            const y = Math.round(rect.top - containerRect.top);
            
            positionX.textContent = x;
            positionY.textContent = y;
        }
        
        function updateWatermarkStyle() {
            if (!watermarkOverlay) return;
            
            if (activeTab === 'text') {
                watermarkOverlay.style.opacity = textOpacity.value / 100;
            } else {
                const img = watermarkOverlay.querySelector('img');
                if (img) {
                    img.style.opacity = watermarkOpacity.value / 100;
                }
            }
        }
        
        function updateWatermarkPreview() {
            if (!watermarkOverlay) {
                initWatermarkOverlay();
                return;
            }
            
            if (activeTab === 'text') {
                watermarkOverlay.textContent = watermarkText.value || 'Your Watermark';
                watermarkOverlay.style.color = textColor.value;
                watermarkOverlay.style.fontFamily = textFont.value;
                watermarkOverlay.style.fontSize = `${textSize.value}px`;
                watermarkOverlay.style.backgroundColor = textBgColor.value;
                watermarkOverlay.style.opacity = textOpacity.value / 100;
            } else if (activeTab === 'image' && watermarkImage) {
                // Clear existing content
                watermarkOverlay.innerHTML = '';
                
                const sizePercent = parseInt(watermarkSize.value) / 100;
                const imgElem = document.createElement('img');
                imgElem.src = watermarkImage.src;
                imgElem.style.width = '100%';
                imgElem.style.height = '100%';
                imgElem.style.opacity = watermarkOpacity.value / 100;
                watermarkOverlay.appendChild(imgElem);
                
                // Set size based on percentage of preview container
                const containerWidth = previewContainer.clientWidth;
                const watermarkWidth = containerWidth * sizePercent;
                watermarkOverlay.style.width = `${watermarkWidth}px`;
                
                // Maintain aspect ratio
                const aspectRatio = watermarkImage.height / watermarkImage.width;
                watermarkOverlay.style.height = `${watermarkWidth * aspectRatio}px`;
                
                // Add resize handle back
                const resizeHandle = document.createElement('div');
                resizeHandle.className = 'watermark-handle';
                watermarkOverlay.appendChild(resizeHandle);
                resizeHandle.addEventListener('mousedown', startResize);
            }
            
            // Re-apply current position
            if (preciseMode) {
                enablePrecisePositioning();
            } else {
                applyGridPosition();
            }
        }
        
        function applyWatermark() {
            if (!currentImage) {
                alert('Please upload an image first.');
                return;
            }
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas dimensions based on HD conversion setting
            let width = currentImage.width;
            let height = currentImage.height;
            
            if (hdConversion.checked) {
                // Increase dimensions for HD (limited to reasonable size)
                const maxDimension = 1920; // Max dimension for HD
                if (width > height && width < maxDimension) {
                    height = Math.round(height * (maxDimension / width));
                    width = maxDimension;
                } else if (height < maxDimension) {
                    width = Math.round(width * (maxDimension / height));
                    height = maxDimension;
                }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // Draw the original image
            ctx.drawImage(currentImage, 0, 0, width, height);
            
            // Apply quality enhancements if selected
            if (enhanceQuality.checked) {
                // Simple sharpening filter
                const imageData = ctx.getImageData(0, 0, width, height);
                const sharpenedData = sharpenImage(imageData, 0.5);
                ctx.putImageData(sharpenedData, 0, 0);
            }
            
            // Calculate watermark position based on overlay position
            if (watermarkOverlay) {
                const containerRect = previewContainer.getBoundingClientRect();
                const overlayRect = watermarkOverlay.getBoundingClientRect();
                
                // Calculate scale factors between preview and actual image
                const scaleX = width / containerRect.width;
                const scaleY = height / containerRect.height;
                
                // Calculate watermark position and size in the actual image
                const watermarkX = (overlayRect.left - containerRect.left) * scaleX;
                const watermarkY = (overlayRect.top - containerRect.top) * scaleY;
                const watermarkWidth = overlayRect.width * scaleX;
                const watermarkHeight = overlayRect.height * scaleY;
                
                // Apply watermark based on active tab
                if (activeTab === 'text') {
                    applyTextWatermark(ctx, watermarkX, watermarkY, watermarkWidth, watermarkHeight);
                } else {
                    if (watermarkImage) {
                        applyImageWatermark(ctx, watermarkX, watermarkY, watermarkWidth, watermarkHeight);
                    } else {
                        alert('Please upload a watermark image first.');
                        return;
                    }
                }
            }
            
            // Update the preview with the watermarked image
            const watermarkedImage = new Image();
            watermarkedImage.onload = function() {
                currentImage = watermarkedImage;
                displayImage(currentImage);
            };
            watermarkedImage.src = canvas.toDataURL('image/jpeg', qualitySlider.value / 100);
        }
        
        function applyTextWatermark(ctx, x, y, width, height) {
            const text = watermarkText.value || 'Your Watermark';
            const fontSize = parseInt(textSize.value) * (width / previewContainer.clientWidth);
            const fontFamily = textFont.value;
            const color = textColor.value;
            const bgColor = textBgColor.value;
            const opacity = parseInt(textOpacity.value) / 100;
            
            ctx.font = `bold ${fontSize}px ${fontFamily}`;
            const textWidth = ctx.measureText(text).width;
            
            // Draw background if color is not fully transparent
            if (bgColor !== '#00000000') {
                ctx.fillStyle = bgColor;
                ctx.globalAlpha = opacity * 0.7; // Slightly less opaque for background
                ctx.fillRect(x, y, textWidth + 20, fontSize + 10);
            }
            
            // Draw text
            ctx.fillStyle = color;
            ctx.globalAlpha = opacity;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            ctx.fillText(text, x + 10, y + 5);
            
            // Reset alpha
            ctx.globalAlpha = 1;
        }
        
        function applyImageWatermark(ctx, x, y, width, height) {
            const opacity = parseInt(watermarkOpacity.value) / 100;
            
            // Apply opacity and draw watermark
            ctx.globalAlpha = opacity;
            ctx.drawImage(watermarkImage, x, y, width, height);
            ctx.globalAlpha = 1;
        }
        
        function sharpenImage(imageData, factor) {
            // Simple sharpening filter using convolution
            const width = imageData.width;
            const height = imageData.height;
            const data = imageData.data;
            const output = new Uint8ClampedArray(data);
            
            // Sharpening kernel
            const kernel = [
                0, -1, 0,
                -1, 5, -1,
                0, -1, 0
            ];
            
            const kernelSize = 3;
            const half = Math.floor(kernelSize / 2);
            
            for (let y = half; y < height - half; y++) {
                for (let x = half; x < width - half; x++) {
                    for (let c = 0; c < 3; c++) { // RGB channels only
                        let sum = 0;
                        for (let ky = -half; ky <= half; ky++) {
                            for (let kx = -half; kx <= half; kx++) {
                                const idx = ((y + ky) * width + (x + kx)) * 4 + c;
                                const kernelIdx = (ky + half) * kernelSize + (kx + half);
                                sum += data[idx] * kernel[kernelIdx];
                            }
                        }
                        
                        const outputIdx = (y * width + x) * 4 + c;
                        output[outputIdx] = Math.max(0, Math.min(255, data[outputIdx] + factor * sum));
                    }
                }
            }
            
            return new ImageData(output, width, height);
        }
        
        function downloadImage() {
            if (!currentImage) {
                alert('Please upload and process an image first.');
                return;
            }
            
            const link = document.createElement('a');
            link.download = 'watermarked-image.jpg';
            link.href = currentImage.src;
            link.click();
        }
        
        // Initialize with some default values
        window.addEventListener('DOMContentLoaded', () => {
            // Set initial values for display
            textSizeValue.textContent = `${textSize.value}px`;
            textColorValue.textContent = textColor.value.toUpperCase();
            textBgColorValue.textContent = textBgColor.value.toUpperCase();
            textOpacityValue.textContent = `${textOpacity.value}%`;
            qualityValue.textContent = `${qualitySlider.value}%`;
            watermarkSizeValue.textContent = `${watermarkSize.value}%`;
            watermarkOpacityValue.textContent = `${watermarkOpacity.value}%`;
            
            // Set precise mode as default
            precisePositionBtn.classList.add('active');
            preciseMode = true;
        });
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (watermarkOverlay && !preciseMode) {
                applyGridPosition();
            }
        });
    </script>
</body>
</html>
